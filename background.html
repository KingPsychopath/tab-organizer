<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <title>Background Page</title>
</head>
<body>
    <script src="lib/Platform.js"></script>
    <script src="lib/Options.js"></script>
    <script>
        "use strict";
        /*global Options, Platform */

        Options.setDefaults({
            "popup.bubble": false,
            "popup.offsetX": 0,
            "popup.offsetY": 0,
            "popup.width": 920,  //! screen.width - 520, // 100 // 916 // 1336
            "popup.height": 496, //! screen.height - 400 // 250 // 502 // 632

            "popup.hotkey.ctrl": true,
            "popup.hotkey.shift": true,
            "popup.hotkey.alt": false,
            "popup.hotkey.letter": "O"
        });

        if (Options.get("popup.bubble")) {
            Platform.icon.setPopup({ popup: "window.html" });
        }
        Options.addEventListener("change", function (event) {
            if (event.name === "popup.bubble") {
                Platform.icon.setPopup({
                    popup: (event.value) ? "window.html" : ""
                });
            }
        }, true);

        function updateTitle() {
            var title = [ "Tab Organizer (" ];

            if (Options.get("popup.hotkey.ctrl")) {
                title.push("Ctrl ");
            }
            if (Options.get("popup.hotkey.shift")) {
                title.push("Shift ");
            }
            if (Options.get("popup.hotkey.alt")) {
                title.push("Alt ");
            }

            title.push(Options.get("popup.hotkey.letter"), ")");

            Platform.icon.setTitle({ title: title.join("") });
        }
        updateTitle();


        var openPopup = (function () {
            function popup(url, info, options) {
                info = Object(info);

                var x = screen.width * (info.offsetX / 100 + 0.5) - (info.width + 8) / 2,
                    y = screen.height * (info.offsetY / 100 + 0.5) - (info.height + 24) / 2;

                options += ",left=" + x;
                options += ",top=" + y;
                options += ",outerWidth=" + info.width;
                options += ",width=" + info.width;
                options += ",outerHeight=" + info.height;
                options += ",height=" + info.height;
                return open(url, "TabOrganizer", options);
            }

            return function anon(tab) {
                if (anon.win) {
                    anon.win.close();
                }
                anon.win = popup("window.html", {
                    offsetX: Options.get("popup.offsetX"),
                    offsetY: Options.get("popup.offsetY"),
                    width: Options.get("popup.width"),
                    height: Options.get("popup.height")
                });
                /*! , "toolbar=1,menubar=1,alwaysRaised=1"*/
            };
        }());

        Platform.icon.addEventListener("click", openPopup, true);

/*
        function keycheck(event, input) {
            return (event.ctrlKey === input.ctrlKey || event.metaKey === input.ctrlKey) &&
                event.shiftKey === input.shiftKey && event.altKey === event.altKey &&
                event.which === input.which;
        }
*/

        Platform.windows.addEventListener("focus", function (win) {
            if (win !== null) {
                Platform.windows.get(win, function (win) {
                    if (win.type === "normal") {
                        Options.set("window.lastfocused", win.id);
                        //state.windows[win.id].setWindowFocus();
                        //state.search();
                    }
                });
            }/* else {
                action.unselectWindow();

                state.search();
            }*/
        }, true);

        Platform.message.addEventListener("lib.keyboard", function (event) {
            if (event.type === "keyup") {
                /*
                if (keycheck(event, {
                    ctrlKey: Options.get("popup.hotkey.ctrl"),
                    shiftKey: Options.get("popup.hotkey.shift"),
                    altKey: Options.get("popup.hotkey.alt"),
                    which: Options.get("popup.hotkey.code")
                })) {
                    openPopup()
                }
                */

                //console.log(event.which);

                var ctrl = Options.get("popup.hotkey.ctrl");
                var letter = String.fromCharCode(event.which);

                //console.log(event);

                if (event.ctrlKey === ctrl || event.metaKey === ctrl) {
                    if (event.shiftKey === Options.get("popup.hotkey.shift")) {
                        if (event.altKey === Options.get("popup.hotkey.alt")) {
                            if (letter === Options.get("popup.hotkey.letter")) {
                                openPopup();
                            }
                        }
                    }
                }
            }
        }, true);
    </script>
</body>
</html>

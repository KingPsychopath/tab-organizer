<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <title>Background Page</title>
</head>
<body>
    <script src="/lib/Options.js"></script>
    <script src="/lib/Platform.js"></script>

    <script src="/lib/Array.js"></script>
    <script src="/lib/Analytics.js"></script>
    <script>
        /*global _gaq, Options, Platform */
        "use strict";

        var defaults = {
            "popup.type": "popup",
            "popup.offsetX": 0,
            "popup.offsetY": 0,
            "popup.width": 920,  //! screen.width - 520, // 100 // 916 // 1336 // 960
            "popup.height": 496, //! screen.height - 400 // 250 // 502 // 632

            "popup.hotkey.ctrl": true,
            "popup.hotkey.shift": true,
            "popup.hotkey.alt": false,
            "popup.hotkey.letter": "E",
            "popup.close.escape": false,

            "undo.new-tab": true,
            "undo.rename-window": true,
            "undo.select-tabs": true,
            "undo.move-tabs": true,
            "undo.close-tabs": false,
            "undo.timer": 6,

            "color.theme": "Blue",

            "tabs.close.location": "right",
            "tabs.close.display": "hover",
            "tabs.click.type": "focus",

            "windows.middle-close": false,
            "windows.type": "horizontal",
            "windows.grid.columns": 3,
            "windows.grid.rows": 1.5,
            "windows.sort.type": "date-created",

            "counter.enabled": true,
            "counter.type": "total",
            "counter.reset.whenlower": true,
            "counter.reset.number": 0,
            "counter.reset.time": false,
            "counter.reset.time.hour": "00",
            "counter.reset.time.minute": "00",
            "counter.reset.idle": false,
            "counter.reset.idle.hour": 10,

            "search.show-number": 5,

            "usage-tracking": true
        };
        Options.setDefaults(defaults);

//        Options.deleteDefault("windows.indent-level");
//        Options.deleteDefault("windows.tab-indent");
//        Options.deleteDefault("tabs.indent-level");
//        Options.deleteDefault("windows.offsets");
//        Options.set("tabs.indent-by-id", {});

        Options.setObject("tabs.favorites.urls");
        Options.setObject("tabs.visited.byURL");
        Options.setObject("counter.state");

        Options.setArray("windows.tab-indent");
//        Options.setArray("tabs.indent-level");
//        Options.setArray("windows.offsets");
        Options.setArray("windows.titles");
        Options.setArray("macros.list");


        var config = Options.snapshot().user;
        var code = "usage-tracking";

        if (Options.get(code)) {
            _gaq.push(["_trackEvent", "Version", "number", "3.5"]);

            _gaq.push(["_trackEvent", "Version", "type", "developer"]);
            //!_gaq.push(["_trackEvent", "Version", "type", "normal"]);

            (function () {
                var favorites = Options.get("tabs.favorites.urls").keys().length;
                if (favorites !== 0) {
                    _gaq.push(["_trackEvent", "Favorites", "tabs.favorites.urls", favorites + "", favorites]);
                }

                var macros = Options.get("macros.list").length;
                if (macros !== 0) {
                    _gaq.push(["_trackEvent", "Macros", "macros.list", macros + "", macros]);
                }
            }());
        }


        var categories = {
            "Counter": ["counter.enabled", "counter.type", "counter.reset.whenlower", "counter.reset.number", "counter.reset.time", "counter.reset.time.hour", "counter.reset.time.minute", "counter.reset.idle", "counter.reset.idle.hour"],

            "Experimental": ["windows.middle-close", "popup.close.escape"],

            "Keyboard": ["popup.hotkey.ctrl", "popup.hotkey.shift", "popup.hotkey.alt", "popup.hotkey.letter"],

            "Popup": ["popup.type", "popup.offsetX", "popup.offsetY", "popup.width", "popup.height"],

            "Privacy": ["usage-tracking"],

            "Search": ["search.show-number"],

            "Tabs": ["tabs.close.location", "tabs.close.display", "tabs.click.type"],

            "Theme": ["color.theme"],

            "Undo": ["undo.new-tab", "undo.rename-window", "undo.select-tabs", "undo.move-tabs", "undo.close-tabs", "undo.timer"],

            "Windows": ["windows.type", "windows.grid.columns", "windows.grid.rows"],

            "Statistics": ["windows.sort.type"],
        };

        Object.keys(categories).forEach(function (category) {
            categories[category].forEach(function (name) {
                if (Options.get(code) || name === code) {
                    if (!Options.isDefault(name)) {
                        var value = Options.get(name);
                        if (typeof value === "number") {
                            _gaq.push(["_trackEvent", category, name, value + "", value]);
                        } else {
                            _gaq.push(["_trackEvent", category, name, value + ""]);
                        }
                    }
                }
            });
        });


        var state = {};

        var counter = Options.get("counter.state");

        counter.reset = function (should) {
            var reset = Options.get("counter.reset.number");
            var lower = Options.get("counter.reset.whenlower");

            /**
             *  Only reset under the following conditions:
             *    1. If explicitly told to, via the argument `should`
             *    2. If lower is unchecked
             *    3. If lower is checked, and the counter's number is lower than the reset number
             */
            if (should || !lower || counter.get("session-number") < reset) {
                counter.set("session-number", reset);
                counter.update();
            }
        };

        counter.timestamp = function () {
            var date = new Date();
            date.setHours(Options.get("counter.reset.time.hour"));
            date.setMinutes(Options.get("counter.reset.time.minute"));
            counter.set("timestamp", date.getTime());
        };
        counter.timestamp();


        counter.update = function (value) {
            if (Options.get("counter.enabled")) {
                switch (Options.get("counter.type")) {
                case "total":
                    value = counter.get("total-number");
                    if (!value) {
                        value = "";
                    }
                    Platform.icon.setBackgroundColor({ color: [0, 0, 0, 255] });
                    break;
                case "session":
                    value = counter.get("session-number");

                    if (typeof value === "undefined") {
                        value = Options.get("counter.reset.number");
                    }

                    if (value > 0) {
                        Platform.icon.setBackgroundColor({ color: [225, 0, 0, 255] });
                    } else {
                        Platform.icon.setBackgroundColor({ color: [0, 100, 0, 255] });
                    }
                }

                Platform.icon.setText({ text: value });
            } else {
                Platform.icon.setText({ text: "" });
            }
        };
        counter.update();


        var day = 1000 * 60 * 60 * 24;

        (function anon() {
            if (Options.get("counter.reset.time")) {
                var time = new Date() - day;
                if (time > counter.get("timestamp")) {
                    counter.timestamp();
                    counter.reset();
                }
            }

            if (Options.get("counter.reset.idle")) {
                var hours = Options.get("counter.reset.idle.hour") * 60 * 60;
                Platform.idle.queryState(hours, function (state) {
                    if (state === "idle") {
                        counter.reset();
                    }
                });
            }

            setTimeout(anon, 60000);
        }());


        Platform.event.on("load", function (windows) {
/*            var focusedByID = {};
            var indexByID = {};
            var tabsByID = {};



            Platform.event.on("tab-create", function (tab) {
                tabsByID[tab.id] = tab;

                var focused = focusedByID[tab.windowId];
                if (focused) {
                    console.log(focused.index);
                }
            });

            Platform.event.on("tab-remove", function (id) {
                indent.splice(indexByID[tabsByID[id].windowId], 1);
            });

            Platform.event.on("tab-focus", function (id, info) {
//                focusedByID[info.windowId] = node;
                Platform.tabs.get(id, function (tab) {
                    focusedByID[info.windowId] = tab;
//                    var list = state.windows[info.windowId],
//                        node = state.tabsByID[id];

//                    if (list && node) {
//                        var scroll = list.tabList;

//                        var old = focusedByID[info.windowId];
//                        if (old) {
//                            node.indentParent = old.index;
//                        }
//                    }
                });
            });
*/
//            var index = 0;
//
            var indent = Options.get("windows.tab-indent");

//            var lastfocused;
//
//            Platform.event.on("tab-focus", function (tab, old) {
//
//            });
//
            /*indent.forEach(function (tabs) {
                tabs.forEach(function (tab, i) {
                    tab.parentId = tabs[tab];
                });
            });*/
//
//            console.warn("foobaaar");

            function trim(array, action) {
                var last = -1;

                array.forEach(function (item, i) {
//                    console.log(!!item);
                    if (item) {
                        last = i;

                        if (typeof action === "function") {
                            action(item, i);
                        }
                    }
                });

                array.length = last + 1;
            }

            trim(indent, function (item, i) {
                trim(item);

                if (item.length === 0) {
                    delete indent[i];
                }
            });


            Platform.event.on("window-remove", function (win) {
//                var level = indent[win.index];
//                if (level) {
//                    console.log("foo");
                indent.splice(win.index, 1);
//                }
            });

            function insert(tab, index) {
                var level = indent[tab.window.index];
                if (level) {
    //                var index = tab.index;
    /*                if (index < 1) {
                        index = null;
                    } else {

                    }*/
//
                    index = (index < 1 ? null : level[index]);

                    level.splice(tab.index, 0, index);

                    Platform.event.trigger("tab-indent", tab, index);
                }
            }

            function moveup(tab, index) {
                var level = indent[tab.window.index];
                if (level) {
                    var parent = level[index];
                    var list = tab.window.tabs;
//
//                    var removed = [];

                    level.splice(index, 1);

                    for (var i = index; i < level.length; i += 1) {
//                        console.log(level[i], parent);
                        if (!level[i] || level[i] <= parent) {
                            break;
                        }
//                        if (typeof parent !== "number" && level[i] === tab.index) {
////                            if () {
////                                level[i] = parent;
////                            } else {
//                            removed.push(i);
////                            }
////
////                            recurse(i, level[i]);
//                        } else {
                        level[i] -= 1;

                        if (level[i] === 0) {
                            delete level[i];
//                            Platform.event.trigger("tab-indent", list[index]);
//                            removed.push(i);
                        }/* else {

                        }*/

                        Platform.event.trigger("tab-indent", list[i], level[i]);
//                        }
                    }
//
                    /*var lastindex = tab.index;

                    for (var i = tab.index; i < level.length; i += 1) {
                        if (level[i]) {
                            lastindex = i;
                        }
                    }

                    level.length = lastindex;*/
/*
                    function recurse(index, parent) {
                        level.forEach(function (item, i) {

                        });
                    }
                    recurse(, );*/
/*
                    removed.forEach(function (index, i) {
                        level.splice(index - i, 1);

                        Platform.event.trigger("tab-indent", list[index]);
                    });*/
                }
            }

            Platform.event.on("tab-move", function (tab, info) {
//                var level = indent[tab.window.index];
//                if (level) {
////                    var parent = level[info.fromIndex];
////                    var index = tab.index;
////
////                    level.splice(info.fromIndex, 1);
                moveup(tab, info.fromIndex);
                insert(tab, tab.index);
//                }
            });

            Platform.event.on("tab-detach", function (tab) {
                moveup(tab, tab.index);
//                var level = indent[tab.window.index];
//                if (level) {
//                    level.splice(tab.index, 1);

                Platform.event.trigger("tab-indent", tab);
//                }
            });

            Platform.event.on("tab-attach", function (tab) {
//                var level = indent[tab.window.index];
//                if (level) {
                insert(tab, tab.index - 1);
/*                    var index = ;
                    if (index < 1) {
                        index = null;
                    } else {
                        index = level[index];
                    }

                    level.splice(tab.index, 0, index);

                    Platform.event.trigger("tab-indent", tab, index);*/
//                }
            });
/*
            Platform.event.on("tab-indent", function (tab, indent) {
                console.log(indent, tab.url);
            });*/

            Platform.event.on("tab-remove", function (tab) {
                moveup(tab, tab.index);
            });
/*
            Platform.event.on("tab-indent", function (tab, indent) {
//                var level = indent[tab.window.index];
//                if (level) {
                console.log(tab, indent);
//                }
            });*/
/*!
            ["tab-update", "tab-create", "window-create"].forEach(function (name) {
                Platform.event.on(name, function () {
                    console.warn(name);
                });
            });*/

            Platform.event.on("tab-create", function anon(tab, focused) {
                focused = focused || Platform.tabs.getSelected(tab.windowId);

//                console.log(tab.url);
                if (tab.url) {
//                if (tab.status === "loading") {
                    Platform.history.lastVisit(tab.url, function (visit) {
                        if (visit.transition === "link") {
//                            console.log(visit.referringVisitId);
//
                            if (tab.index !== focused.index) {
//                                try {
                                var index = tab.window.index;
//                                } catch (e) {
//                                    console.error(e);
//                                }

                                if (!indent[index]) {
                                    indent[index] = [];
                                }
                                var level = indent[index];

                                var amount = level[focused.index] + 1 || 1;

                                if (level.length < tab.index) {
                                    level.length = tab.index;
                                }
//
//                                console.log(tab.index);

                                level.splice(tab.index, 0, amount);
//                                tab.parentId = focused.id;

                                Platform.event.trigger("tab-indent", tab, amount);
                            }
//                            console.log(tab, focused);
                        }
//                        console.log(visit.transition);
                    });
                } else {
                    console.log("Refreshing");
                    setTimeout(function () {
                        anon(tab, focused);
                    }, 25);
//                    console.error(tab);
                }
            });


            var tabcount = 0;

            windows.forEach(function (item) {
//                indent[i] = indent[i] || [];
//                var level = indent[i];
//                    windowsByID[item.id] = i;
//
                tabcount += item.tabs.length;
//
//                item.tabs.forEach(function (tab, i) {
//                    level[i] = level[i]
//                    tab.indentLevel = indent[tab.globalIndex];
//                    console.log(tab.globalIndex);
//                    if (!(tab.globalIndex in indent)) {
//                        indent[tab.globalIndex] = 0;
//                    }
//                    index += 1;
//                });
//
                /*item.tabs.forEach(function (tab) {
                    if (tab.selected) {
                        focusedByID[item.id] = tab;
                    }
                });*/
            });

//            Platform.windows.getAll().forEach(function (windows) {
//
//            });

            counter.set("total-number", tabcount);
            counter.update();

            if (Options.get(code)) {
                _gaq.push(["_trackEvent", "Statistics", "windows.length", windows.length + "", windows.length]);
                _gaq.push(["_trackEvent", "Statistics", "tabs.length", tabcount + "", tabcount]);
            }

            function add() {
                counter.set("total-number", counter.get("total-number") + 1);
                counter.set("session-number", counter.get("session-number") + 1);
                counter.update();
            }
            function subtract() {
                counter.set("total-number", counter.get("total-number") - 1);
                counter.set("session-number", counter.get("session-number") - 1);
                counter.update();
            }
            Platform.event.on("tab-create", add);
            Platform.event.on("tab-remove", subtract);
        });



        if (Options.get("popup.type") === "bubble") {
            Platform.icon.setPopup({ popup: "window.html" });
        }


        Options.event.on("change", function (event) {
            switch (event.name) {
            case "counter.reset.time.hour": //* FALLTHRU
            case "counter.reset.time.minute":
                counter.timestamp();
                break;
            case "counter.type":
                counter.update();
                break;
            case "counter.enabled":
                if (event.value) {
                    if (!counter.get("first-run")) {
                        counter.set("first-run", true);
                        counter.reset();
                    }
                }
                counter.update();
                break;
            case "popup.type":
                Platform.icon.setPopup({
                    popup: (event.value === "bubble") ? "window.html" : ""
                });
            }
        });


        function updateTitle() {
            var title = [ "Tab Organizer (" ];

            if (Options.get("popup.hotkey.ctrl")) {
                title.push("Ctrl ");
            }
            if (Options.get("popup.hotkey.shift")) {
                title.push("Shift ");
            }
            if (Options.get("popup.hotkey.alt")) {
                title.push("Alt ");
            }

            title.push(Options.get("popup.hotkey.letter"), ")");

            Platform.icon.setTitle({ title: title.join("") });
        }
        updateTitle();


        var openPopup = (function () {
            function popup(url, info, options) {
                info = Object(info);

                var x = screen.width * (info.offsetX / 100 + 0.5) - (info.width + 8) / 2,
                    y = screen.height * (info.offsetY / 100 + 0.5) - (info.height + 24) / 2;

                options += ",left=" + x;
                options += ",top=" + y;
                options += ",outerWidth=" + info.width;
                options += ",width=" + info.width;
                options += ",outerHeight=" + info.height;
                options += ",height=" + info.height;
                return open(url, "TabOrganizer", options);
            }

            return function () {
                if (state.opened) {
                    Platform.tabs.remove(state.opened);
                }

                return popup("window.html", {
                    offsetX: Options.get("popup.offsetX"),
                    offsetY: Options.get("popup.offsetY"),
                    width: Options.get("popup.width"),
                    height: Options.get("popup.height")
                });
                /*! , "toolbar=1,menubar=1,alwaysRaised=1"*/
            };
        }());

        var showTabOrganizer = function anon() {
            var popup = anon.popup;
            if (popup && !popup.closed) {
                popup.addEventListener("unload", showTabOrganizer, false);
                popup.close();
                delete anon.popup;
                return null;
            }

            switch (Options.get("popup.type")) {
            case "bubble":
                anon.popup = openPopup();
                break;
            case "popup":
                anon.popup = openPopup();
                break;
            case "tab":
                if (state.opened) {
                    Platform.tabs.focus(state.opened, true);
                } else if (state.opened !== null) {
                    state.opened = null;

                    Platform.tabs.create({
                        url: "window.html"
                    }, function (tab) {
                        state.opened = tab;
                    });
                }
            }
        };
        Platform.event.on("icon-click", showTabOrganizer);

        Platform.event.on("tab-remove", function (tab) {
            if (state.opened && state.opened.id === tab.id) {
                delete state.opened;
            }
        });


        (function () {
            var visitedByURL = Options.get("tabs.visited.byURL");

            var offset = Date.now() - 1000 * 60 * 60 * 24 * 7;

            visitedByURL.keys().forEach(function (key) {
                var value = visitedByURL.get(key);
                if (offset > value) {
                    visitedByURL.set(key, null);
                }
            });


            function add(url) {
                visitedByURL.set(url, Date.now());
            }

            Platform.event.on("tab-focus", function (tab) {
                add(tab.url);
//                Platform.tabs.get(id, function (tab) {
//
//                });
            });

            Platform.event.on("tab-update", function (tab) {
                if (tab.status === "loading" && tab.selected) {
                    add(tab.url);
                }
            });
        }());

        Platform.event.on("window-focus", function (win) {
            if (win.type === "normal") {
                Options.set("window.lastfocused", win.id);
            }
//            if (win !== null) {
//                Platform.windows.get(win, function (win) {
//
//                });
//            }
        });

        Platform.message.on("lib.keyboard", function (event) {
            if (event.type === "keyup") {
                var ctrl = Options.get("popup.hotkey.ctrl");
                var letter = String.fromCharCode(event.which);

                if (event.ctrlKey === ctrl || event.metaKey === ctrl) {
                    if (event.shiftKey === Options.get("popup.hotkey.shift")) {
                        if (event.altKey === Options.get("popup.hotkey.alt")) {
                            if (letter === Options.get("popup.hotkey.letter")) {
                                showTabOrganizer();
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <title>Background Page</title>
</head>
<body>
    <script src="/lib/Platform.js"></script>
    <script src="/lib/Options.js"></script>

    <script src="/lib/Array.js"></script>
    <script src="/lib/Analytics.js"></script>
    <script>
        "use strict";
        /*global Options, Platform */

        var defaults = {
            "popup.type": "popup",
            "popup.offsetX": 0,
            "popup.offsetY": 0,
            "popup.width": 920,  //! screen.width - 520, // 100 // 916 // 1336
            "popup.height": 496, //! screen.height - 400 // 250 // 502 // 632

            "popup.hotkey.ctrl": true,
            "popup.hotkey.shift": true,
            "popup.hotkey.alt": false,
            "popup.hotkey.letter": "E",
            "popup.close.escape": false,

            "undo.new-tab": true,
            "undo.rename-window": true,
            "undo.select-tabs": true,
            "undo.move-tabs": true,
            "undo.close-tabs": false,
            "undo.timer": 6,

            "color.theme": "Blue",

            "tabs.close.location": "right",
            "tabs.close.display": "hover",

            "windows.middle-close": false,

            "counter.enabled": false,
            "counter.reset.number": 5,
            "counter.reset.time": false,
            "counter.reset.time.hour": "00",
            "counter.reset.time.minute": "00",
            "counter.reset.idle": false,
            "counter.reset.idle.hour": 10,

            "search.show-number": 5,

            "usage-tracking": true
        };
        Options.setDefaults(defaults);

        Options.setObject("tabs.favorites.urls");
        Options.setObject("counter.state");

        //Options.set("usage-tracking", true);

/*
        Object.values = function (object) {
            if (typeof action === "function") {
                Object.keys(object).forEach(function (item, i, array) {
                    action(object[item], i, array);
                });
            }
        };
*/

        var config = Options.snapshot().user;
        var code = "usage-tracking";

        if (Options.get(code)) {
            _gaq.push(["_trackEvent", "Version", "number", "3.2"]);

            //_gaq.push(["_trackEvent", "Version", "type", "normal"]);
            _gaq.push(["_trackEvent", "Version", "type", "developer"]);
        }

        //console.log(config);

        Object.keys(config).forEach(function (key) {
            if (key in defaults) {
                if (Options.get(code) || key === code) {
                    if (config[key] !== defaults[key]) {
                        _gaq.push(["_trackEvent", "Options", key, config[key] + ""]);
    //                    console.log("tracked -", key, config[key] + "");
                    }
                }
//                else {
//                    //console.log(true, key, config[key]);
//                }
            }
//            else {
//                //console.log(false, key, config[key]);
//            }
//            setTimeout(function () {
//                command.next();
//            }, 1000);
        });
        //console.log(_gaq);

        //_gaq.push(["_trackEvent", "Options", "name", "value]);

        var state = {};

        var counter = Options.get("counter.state");

        counter.reset = function () {
            counter.set("number", Options.get("counter.reset.number"));
            counter.update();
        };

        counter.timestamp = function () {
            var date = new Date();
            date.setHours(Options.get("counter.reset.time.hour"));
            date.setMinutes(Options.get("counter.reset.time.minute"));
            counter.set("timestamp", date.getTime());
        };
        counter.timestamp();

/*        if (!counter.get("timestamp")) {

        }*/
/*        if (!counter.get("hour")) {
            container.set("hour", Date
        }*/

        counter.update = function () {
            if (Options.get("counter.enabled")) {
                var value = counter.get("number");
                if (value > 0) {
                    Platform.icon.setBackgroundColor({ color: [225, 0, 0, 255] });
                } else {
                    Platform.icon.setBackgroundColor({ color: [0, 100, 0, 255] });
                }
                Platform.icon.setText({ text: value });
            } else {
                Platform.icon.setText({ text: "" });
            }
        };
        counter.update();


        var day = 1000 * 60 * 60 * 24;

        (function anon() {
            if (Options.get("counter.reset.time")) {
                var time = new Date() - day;
                if (time > counter.get("timestamp")) {
                    counter.timestamp();
                    counter.reset();
                }
            }

            if (Options.get("counter.reset.idle")) {
                var hours = Options.get("counter.reset.idle.hour") * 60 * 60;
                chrome.idle.queryState(hours, function (state) {
                    if (state === "idle") {
                        counter.reset();
                    }
                });
            }

            setTimeout(anon, 60000);
        }());

//        var startCounter, stopCounter;

        (function () {
            function add() {
                counter.set("number", counter.get("number") + 1);
                counter.update();
            }
            function subtract() {
                counter.set("number", counter.get("number") - 1);
                counter.update();
            }
            Platform.tabs.addEventListener("create", add, true);
            Platform.tabs.addEventListener("remove", subtract, true);

//            startCounter = function () {
//                Platform.icon.setText({ text: counter.get("number") });
//            };
//            stopCounter = function () {
//                Platform.icon.setText({ text: "" });
//                //Platform.tabs.removeEventListener("create", add, true);
//                //Platform.tabs.removeEventListener("remove", subtract, true);
//            };
        }());


//        if (Options.get("counter.enabled")) {
//            startCounter();
//        }
        if (Options.get("popup.type") === "bubble") {
            Platform.icon.setPopup({ popup: "window.html" });
        }

        Options.addEventListener("change", function (event) {
            switch (event.name) {
            case "counter.reset.time.hour": //* FALLTHRU
            case "counter.reset.time.minute":
                counter.timestamp();
                break;
            case "counter.enabled":
                if (event.value) {
                    if (!counter.get("first-run")) {
                        counter.set("first-run", true);
                        counter.reset();
                    }
                }
                counter.update();
//                if (event.value) {
//                    startCounter();
//                } else {
//                    stopCounter();
//                }
                break;
            case "popup.type":
                Platform.icon.setPopup({
                    popup: (event.value === "bubble") ? "window.html" : ""
                });
            }
        }, true);


        function updateTitle() {
            var title = [ "Tab Organizer (" ];

            if (Options.get("popup.hotkey.ctrl")) {
                title.push("Ctrl ");
            }
            if (Options.get("popup.hotkey.shift")) {
                title.push("Shift ");
            }
            if (Options.get("popup.hotkey.alt")) {
                title.push("Alt ");
            }

            title.push(Options.get("popup.hotkey.letter"), ")");

            Platform.icon.setTitle({ title: title.join("") });
        }
        updateTitle();


/*        function updateText() {
            Platform.icon.setText({ text: counter.get("number") });
        }
        updateText();*/


        var openPopup = (function () {
            function popup(url, info, options) {
                info = Object(info);

                var x = screen.width * (info.offsetX / 100 + 0.5) - (info.width + 8) / 2,
                    y = screen.height * (info.offsetY / 100 + 0.5) - (info.height + 24) / 2;

                options += ",left=" + x;
                options += ",top=" + y;
                options += ",outerWidth=" + info.width;
                options += ",width=" + info.width;
                options += ",outerHeight=" + info.height;
                options += ",height=" + info.height;
//                options += "alwaysRaised=yes";
                return open(url, "TabOrganizer", options);
            }

            return function () {
                /*if (state.opened) {
                    Platform.tabs.focus(state.opened);
                }*/

                if (state.opened) {
                    Platform.tabs.remove(state.opened.id);
                }

                return popup("window.html", {
                    offsetX: Options.get("popup.offsetX"),
                    offsetY: Options.get("popup.offsetY"),
                    width: Options.get("popup.width"),
                    height: Options.get("popup.height")
                });
                /*! , "toolbar=1,menubar=1,alwaysRaised=1"*/
            };
        }());

        var showTabOrganizer = function anon() {
            var popup = anon.popup;
            if (popup && !popup.closed) {
                popup.addEventListener("unload", showTabOrganizer, false);
                popup.close();
                delete anon.popup;
                return null;
            }

            switch (Options.get("popup.type")) {
            case "bubble":
                anon.popup = openPopup();
                break;
            case "popup":
                anon.popup = openPopup();
                break;
            case "tab":
                if (state.opened) {
                    Platform.tabs.focus(state.opened);
                } else if (state.opened !== null) {
                    state.opened = null;

                    Platform.tabs.create({
                        url: "window.html"
                    }, function (tab) {
                        state.opened = tab;
                    });
                }
            }
        };
        Platform.tabs.addEventListener("remove", function (id) {
            if (state.opened && state.opened.id === id) {
                delete state.opened;
            }
        }, true);

        Platform.icon.addEventListener("click", showTabOrganizer, true);

/*
        function keycheck(event, input) {
            return (event.ctrlKey === input.ctrlKey || event.metaKey === input.ctrlKey) &&
                event.shiftKey === input.shiftKey && event.altKey === event.altKey &&
                event.which === input.which;
        }
*/

        Platform.windows.addEventListener("focus", function (win) {
//            console.log(win);
//            clearTimeout(anon.timer);
            if (win !== null) {
//                if (anon.timer) {
//                    setTimeout(function () {
//                        anon.timer = false;
//                    }, 100);
//                } else {
//                    //                    anon.timer = true;
//    //                alert();
//                    Options.set("window.lastfocused", null, { verbatim: true });

//                    //action.unselectWindow();
//                    //state.search();
//                }
//            } else {
//                anon.timer = true;
                Platform.windows.get(win, function (win) {
                    if (win.type === "normal") {
                        Options.set("window.lastfocused", win.id);
                        //state.windows[win.id].setWindowFocus();
                        //state.search();
                    }
                });
            }
        }, true);

        Platform.message.addEventListener("lib.keyboard", function (event) {
            //console.log(event);
            if (event.type === "keyup") {
                /*
                if (keycheck(event, {
                    ctrlKey: Options.get("popup.hotkey.ctrl"),
                    shiftKey: Options.get("popup.hotkey.shift"),
                    altKey: Options.get("popup.hotkey.alt"),
                    which: Options.get("popup.hotkey.code")
                })) {
                    showTabOrganizer()
                }
                */

                //console.log(event.which);

                var ctrl = Options.get("popup.hotkey.ctrl");
                var letter = String.fromCharCode(event.which);

                //console.log(event);

                if (event.ctrlKey === ctrl || event.metaKey === ctrl) {
                    if (event.shiftKey === Options.get("popup.hotkey.shift")) {
                        if (event.altKey === Options.get("popup.hotkey.alt")) {
                            if (letter === Options.get("popup.hotkey.letter")) {
                                showTabOrganizer();
                            }
                        }
                    }
                }
            }
        }, true);

        Platform.message.addEventListener("lib.action", function (json, port) {
            switch (json.type) {
            case "focus":
                Platform.tabs.focus(port.tab);
                break;
            case "remove":
                Platform.tabs.remove(port.tab.id);
            }
        }, true);
    </script>
</body>
</html>
